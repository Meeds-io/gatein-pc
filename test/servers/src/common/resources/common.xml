<?xml version="1.0"?>
<project name="portlet-integration-test">

   <property name="target.dir" value="${basedir}/target"/>
   <property name="test.dir" value="${target.dir}/integration-tests"/>
   <property name="test.cargo.dir" value="${test.dir}/cargo/"/>

   <target name="tests.common" depends="prepare_env, __evaluate_properties.init" >

      <echo message="compile classpath: ${compile_classpath}"/>
      <echo message="runtime classpath: ${runtime_classpath}"/>
      <echo message="test classpath:    ${test_classpath}"/>
      <echo message="plugin classpath:  ${plugin_classpath}"/>

      <echo message="You can run small subset of tests using -Dtests=local, -Dtests=jboss, or -Dtests=tomcat"/>
      <echo message="-Dtests=local will only run the tests on your locally installed servlet containers"/>

      <antcall target="package-tests"/>

      <!--<antcall target="tests.call.single"/>-->
      <!--<antcall target="__evaluate_properties.all"/>-->
      <antcall target="test.container-servlet"/>
      <!--<antcall target="tests.call.all"/>-->

   </target>

   <target name="tests.call.all" unless="tests">
      <antcall target="__evaluate_properties.all"/>
      <!--<antcall target="tests.jboss"/>-->
      <antcall target="tests.tomcat"/>
      <!--<antcall target="tests.jetty"/>-->
   </target>

   <target name="tests.call.single" if="tests">
      <antcall target="__evaluate_properties.${tests}"/>
      <antcall target="tests.${tests}"/>
   </target>

   <target name="prepare_env">

      <!--Relative path to target dir-->
      <property name="target" value="${basedir}/target"/>
      <property name="test.temp.dir" value="${target}/test/tmp"/>
      <property name="test.temp.portlet" value="${test.temp.dir}/portlet-test"/>
      <property name="test.temp.lib" value="${test.temp.dir}/lib"/>

      <mkdir dir="${test.temp.dir}"/>
      <mkdir dir="${test.temp.lib}"/>
      <mkdir dir="${target}/jboss-unit"/>

      <echo message="Preparing environment"/>

      <path id="jboss-logging">
         <pathelement path="${dependency.jboss-logging-spi.jar}"/>
         <pathelement path="${dependency.jboss-logging-jdk.jar}"/>
         <pathelement path="${dependency.jboss-logging-log4j.jar}"/>
      </path>

      <path id="jboss-microcontainer">
         <pathelement path="${dependency.jboss-kernel.jar}"/>
         <pathelement path="${dependency.jboss-dependency.jar}"/>
         <pathelement path="${dependency.jboss-reflect.jar}"/>
         <pathelement path="${dependency.jboss-mdr.jar}"/>
         <pathelement path="${dependency.jbossxb.jar}"/>
      </path>

      <path id="portal-common">
         <pathelement path="${dependency.portal-common-mc.jar}"/>
      </path>

      <path id="portal-common-shared">
         <pathelement path="${dependency.portal-common-common.jar}"/>
         <pathelement path="${dependency.portal-common-logging.jar}"/>
         <pathelement path="${dependency.slf4j-simple.jar}"/>
         <pathelement path="${dependency.slf4j-api.jar}"/>
      </path>

      <path id="portal-web">
      </path>

      <path id="portal-web-shared">
         <pathelement path="${dependency.portal-wci-wci.jar}"/>
      </path>

      <path id="portal-portlet">
         <pathelement path="${dependency.portal-portlet-controller.jar}"/>
         <pathelement path="${dependency.portal-portlet-mc.jar}"/>
         <pathelement path="${dependency.portal-portlet-tests.jar}"/>
      </path>

      <path id="portal-portlet-shared">
         <path location="${dependency.portal-portlet-portlet.jar}"/>
         <path location="${dependency.portal-portlet-api.jar}"/>
         <path location="${dependency.jsr168api.jar}"/>
      </path>

      <path id="jboss-unit">
      </path>

      <path id="jboss-unit-shared">
         <pathelement path="${dependency.jboss-unit.jar}"/>
         <pathelement path="${dependency.jboss-unit-mc.jar}"/>
         <pathelement path="${dependency.jboss-unit-remote.jar}"/>
         <pathelement path="${dependency.portal-test-generic.jar}"/>
         <pathelement path="${dependency.portal-test.jar}"/>
         <pathelement path="${dependency.jboss-remoting.jar}"/>
      </path>

      <path id="JBoss-4.2">
         <path refid="portal-common"/>
         <path refid="portal-web"/>
         <path refid="portal-portlet"/>
         <path refid="jboss-microcontainer"/>
         <path location="${dependency.jboss-common-core.jar}"/>
      </path>

      <path id="JBoss-4.2-shared">
         <path refid="portal-common-shared"/>
         <path refid="portal-web-shared"/>
         <path refid="portal-portlet-shared"/>
         <path refid="jboss-unit-shared"/>
         <path location="${dependency.ccpp.jar}"/>
         <path location="${dependency.portal-wci-tomcat.jar}"/>
      </path>

      <path id="JBoss-5.1">
         <path refid="portal-common"/>
         <path refid="portal-web"/>
         <path refid="portal-portlet"/>
         <path refid="jboss-microcontainer"/>
         <path location="${dependency.jboss-common-core.jar}"/>
      </path>

      <path id="JBoss-5.1-shared">
         <path refid="portal-common-shared"/>
         <path refid="portal-web-shared"/>
         <path refid="portal-portlet-shared"/>
         <path refid="jboss-unit-shared"/>
         <path location="${dependency.ccpp.jar}"/>
         <path location="${dependency.portal-wci-tomcat.jar}"/>
         
         <!-- paths needed for remote jboss deployment -->
         <path path="${dependency.cargo-jboss-deployer.jar}"/>
         <path path="${dependency.jboss-profile-service.jar}"/>
         <path path="${dependency.cargo-core-container-jboss.jar}"/>
      </path>

      <path id="Tomcat-6.0">
         <path refid="portal-common"/>
         <path refid="portal-web"/>
         <path refid="portal-portlet"/>
         <path refid="jboss-unit"/>
         <path refid="jboss-microcontainer"/>
         <pathelement path="${dependency.javassist.jar}"/>
         <pathelement path="${dependency.xercesImpl.jar}"/>
         <pathelement path="${dependency.resolver.jar}"/>
         <pathelement path="${dependency.xml-apis.jar}"/>
         <pathelement path="${dependency.trove.jar}"/>
      </path>

      <path id="Tomcat-6.0-shared">
         <path refid="portal-common-shared"/>
         <path refid="portal-web-shared"/>
         <path refid="portal-portlet-shared"/>
         <path refid="jboss-unit-shared"/>
         <path refid="jboss-logging"/>
         <path location="${dependency.jboss-common-core.jar}"/>
         <path location="${dependency.log4j.jar}"/>
         <path location="${dependency.concurrent.jar}"/>
         <path location="${dependency.activation.jar}"/>
         <path location="${dependency.jaxb.jar}"/>
         <path location="${dependency.ccpp.jar}"/>
         <path location="${dependency.jboss-serialization.jar}"/>
         <path location="${dependency.portal-wci-tomcat.jar}"/>
      </path>

      <path id="Tomcat-7.0">
         <path refid="portal-common"/>
         <path refid="portal-web"/>
         <path refid="portal-portlet"/>
         <path refid="jboss-unit"/>
         <path refid="jboss-microcontainer"/>
         <pathelement path="${dependency.javassist.jar}"/>
         <pathelement path="${dependency.xercesImpl.jar}"/>
         <pathelement path="${dependency.resolver.jar}"/>
         <pathelement path="${dependency.xml-apis.jar}"/>
         <pathelement path="${dependency.trove.jar}"/>
      </path>

      <path id="Tomcat-7.0-shared">
         <path refid="portal-common-shared"/>
         <path refid="portal-web-shared"/>
         <path refid="portal-portlet-shared"/>
         <path refid="jboss-unit-shared"/>
         <path refid="jboss-logging"/>
         <path location="${dependency.jboss-common-core.jar}"/>
         <path location="${dependency.log4j.jar}"/>
         <path location="${dependency.concurrent.jar}"/>
         <path location="${dependency.activation.jar}"/>
         <path location="${dependency.jaxb.jar}"/>
         <path location="${dependency.ccpp.jar}"/>
         <path location="${dependency.jboss-serialization.jar}"/>
         <path location="${dependency.portal-wci-tomcat.jar}"/>
      </path>

      <path id="Jetty-6.1">
         <path refid="portal-common"/>
         <path refid="portal-web"/>
         <path refid="portal-portlet"/>
         <path refid="jboss-unit"/>
         <path refid="jboss-microcontainer"/>
         <pathelement path="${dependency.javassist.jar}"/>
         <pathelement path="${dependency.xercesImpl.jar}"/>
         <pathelement path="${dependency.resolver.jar}"/>
         <pathelement path="${dependency.xml-apis.jar}"/>
         <pathelement path="${dependency.trove.jar}"/>
      </path>

      <path id="Jetty-6.1-shared">
         <path refid="portal-common-shared"/>
         <path refid="portal-web-shared"/>
         <path refid="portal-portlet-shared"/>
         <path refid="jboss-unit-shared"/>
         <path refid="jboss-logging"/>
         <path location="${dependency.jboss-common-core.jar}"/>
         <path location="${dependency.log4j.jar}"/>
         <path location="${dependency.concurrent.jar}"/>
         <path location="${dependency.activation.jar}"/>
         <path location="${dependency.jaxb.jar}"/>
         <path location="${dependency.ccpp.jar}"/>
         <path location="${dependency.jboss-serialization.jar}"/>
         <path location="${dependency.portal-wci-jetty.jar}"/>
      </path>

   </target>

   <!-- Check which servlet containers are known -->
   <target name="__evaluate_properties.init">

      <property environment="env"/>

      <!--If properties are not in command line check if they are set in env-->
      <condition property="JBOSS_4_2_1_HOME" value="${env.JBOSS_4_2_1_HOME}">
         <and>
            <isset property="env.JBOSS_4_2_1_HOME"/>
            <not>
               <isset property="JBOSS_4_2_1_HOME"/>
            </not>
         </and>
      </condition>
      <condition property="JBOSS_4_2_2_HOME" value="${env.JBOSS_4_2_2_HOME}">
         <and>
            <isset property="env.JBOSS_4_2_2_HOME"/>
            <not>
               <isset property="JBOSS_4_2_2_HOME"/>
            </not>
         </and>
      </condition>
      <condition property="JBOSS_4_2_0_HOME" value="${env.JBOSS_4_2_0_HOME}">
         <and>
            <isset property="env.JBOSS_4_2_0_HOME"/>
            <not>
               <isset property="JBOSS_4_2_0_HOME"/>
            </not>
         </and>
      </condition>
      <condition property="JBOSS_4_2_3_HOME" value="${env.JBOSS_4_2_3_HOME}">
         <and>
            <isset property="env.JBOSS_4_2_3_HOME"/>
            <not>
               <isset property="JBOSS_4_2_3_HOME"/>
            </not>
         </and>
      </condition>
      <condition property="JBOSS_5_1_0_HOME" value="${env.JBOSS_5_1_0_HOME}">
         <and>
            <isset property="env.JBOSS_5_1_0_HOME"/>
            <not>
               <isset property="JBOSS_5_1_0_HOME"/>
            </not>
         </and>
      </condition>
      <condition property="TOMCAT_6_0_HOME" value="${env.TOMCAT_6_0_HOME}">
         <and>
            <isset property="env.TOMCAT_6_0_HOME"/>
            <not>
               <isset property="TOMCAT_6_0_HOME"/>
            </not>
         </and>
      </condition>
      <condition property="TOMCAT_7_0_HOME" value="${env.TOMCAT_7_0_HOME}">
         <and>
            <isset property="env.TOMCAT_7_0_HOME"/>
            <not>
               <isset property="TOMCAT_7_0_HOME"/>
            </not>
         </and>
      </condition>
      <condition property="JETTY_6_1_HOME" value="${env.JETTY_6_1_HOME}">
         <and>
            <isset property="env.JETTY_6_1_HOME"/>
            <not>
               <isset property="JETTY_6_1_HOME"/>
            </not>
         </and>
      </condition>

      <echo message="JBOSS_4_2_0_HOME: ${JBOSS_4_2_0_HOME}"/>
      <echo message="JBOSS_4_2_1_HOME: ${JBOSS_4_2_1_HOME}"/>
      <echo message="JBOSS_4_2_2_HOME: ${JBOSS_4_2_2_HOME}"/>
      <echo message="JBOSS_4_2_3_HOME: ${JBOSS_4_2_3_HOME}"/>
      <echo message="JBOSS_5_1_0_HOME: ${JBOSS_5_1_0_HOME}"/>
      <echo message="TOMCAT_6_0_HOME: ${TOMCAT_6_0_HOME}"/>
      <echo message="TOMCAT_7_0_HOME: ${TOMCAT_7_0_HOME}"/>
      <echo message="JETTY_6_1_HOME: ${JETTY_6_1_HOME}"/>
   </target>

   <target name="__evaluate_properties.tomcat">
      <fail message="Please set the environment variable TOMCAT_6_0_HOME">
         <condition>
            <and>
               <not>
                  <isset property="TOMCAT_6_0_HOME"/>
               </not>
            </and>
         </condition>
      </fail>
   </target>

   <target name="__evaluate_properties.jetty">
      <fail message="Please set the environment variable JETTY_6_1_HOME">
         <condition>
            <and>
               <not>
                  <isset property="JETTY_6_1_HOME"/>
               </not>
            </and>
         </condition>
      </fail>
   </target>

   <target name="__evaluate_properties.jboss">
      <fail message="Please set the environment variables JBOSS_4_2_0_HOME, JBOSS_4_2_1_HOME, JBOSS_4_2_2_HOME and JBOSS_4_2_3_HOME">
         <condition>
            <and>
               <not>
                  <isset property="JBOSS_4_2_0_HOME"/>
               </not>
               <not>
                  <isset property="JBOSS_4_2_1_HOME"/>
               </not>
               <not>
                  <isset property="JBOSS_4_2_2_HOME"/>
               </not>
               <not>
                  <isset property="JBOSS_4_2_3_HOME"/>
               </not>
            </and>
         </condition>
      </fail>
      <fail message="Please set the environment variable JBOSS_5_1_0_HOME">
         <condition>
            <and>
               <not>
                  <isset property="JBOSS_5_1_0_HOME"/>
               </not>
            </and>
         </condition>
      </fail>
   </target>

   <target name="__evaluate_properties.local">
      <!-- empty on purpose! -->
   </target>

   <target name="__evaluate_properties.all">
      <antcall target="__evaluate_properties.jboss"/>
      <antcall target="__evaluate_properties.jetty"/>
      <antcall target="__evaluate_properties.tomcat"/>
   </target>

   <macrodef name="package-ext-test">
      <attribute name="test"/>
      <sequential>
         <package-testsuite testsuiteversion="jsr168" testsuitetype="ext" testsuitename="@{test}"/>
      </sequential>
   </macrodef>

   <macrodef name="package-tck-test">
      <attribute name="test"/>
      <sequential>
         <package-testsuite testsuiteversion="jsr168" testsuitetype="tck" testsuitename="@{test}"/>
      </sequential>
   </macrodef>

   <macrodef name="package-api-test">
      <attribute name="test"/>
      <sequential>
         <package-testsuite testsuiteversion="jsr168" testsuitetype="api" testsuitename="@{test}"/>
      </sequential>
   </macrodef>

   <macrodef name="package-jsr286-tck-test">
      <attribute name="test"/>
      <sequential>
         <package-testsuite testsuiteversion="jsr286" testsuitetype="tck" testsuitename="@{test}"/>
      </sequential>
   </macrodef>

   <macrodef name="package-jsr286-api-test">
      <attribute name="test"/>
      <sequential>
         <package-testsuite testsuiteversion="jsr286" testsuitetype="api" testsuitename="@{test}"/>
      </sequential>
   </macrodef>

   <macrodef name="package-jsr286-ext-test">
      <attribute name="test"/>
      <sequential>
         <package-testsuite testsuiteversion="jsr286" testsuitetype="ext" testsuitename="@{test}"/>
      </sequential>
   </macrodef>

   <macrodef name="package-testsuite">
      <attribute name="testsuiteversion"/>
      <attribute name="testsuitetype"/>
      <attribute name="testsuitename"/>
      <sequential>
         
         <mkdir dir="${test.temp.dir}/@{testsuiteversion}/@{testsuitetype}/@{testsuitename}-war/WEB-INF/classes"/>
         <copy todir="${test.temp.dir}/@{testsuiteversion}/@{testsuitetype}/@{testsuitename}-war/WEB-INF/classes">
            <fileset
               dir="${target}/test-classes"
               includes="org/gatein/pc/test/portlet/@{testsuiteversion}/@{testsuitetype}/common/**"/>
            <fileset
               dir="${target}/test-classes"
               includes="org/gatein/pc/test/portlet/@{testsuiteversion}/common/**"/>
            <fileset
               dir="${target}/test-classes"
               includes="org/gatein/pc/test/portlet/common/**"/>
            <fileset
               dir="${target}/test-classes"
               includes="org/gatein/pc/test/portlet/@{testsuiteversion}/@{testsuitetype}/@{testsuitename}/**"/>
            <fileset
               dir="${target}/classes"
               includes="org/gatein/pc/test/portlet/framework/**"/>
         </copy>
         <copy todir="${test.temp.dir}/@{testsuiteversion}/@{testsuitetype}/@{testsuitename}-war/WEB-INF/lib">
            <fileset
               dir="${test.temp.lib}"
               includes="portal-portlet-test-framework-lib.jar"/>
         </copy>
         <copy todir="${test.temp.dir}/@{testsuiteversion}/@{testsuitetype}/@{testsuitename}-war">
            <fileset
               dir="${target}/test-classes/@{testsuiteversion}/@{testsuitetype}/@{testsuitename}-war"/>
         </copy>
         <jar jarfile="${test.temp.lib}/test-@{testsuiteversion}-@{testsuitetype}-@{testsuitename}.war">
            <fileset dir="${test.temp.dir}/@{testsuiteversion}/@{testsuitetype}/@{testsuitename}-war"/>
         </jar>
      </sequential>
   </macrodef>

   <target name="package-tests">
      
      <copy todir="${target}/classes">
         <fileset dir="${basedir}/../../core/target/classes" includes="**/*"/>
      </copy>
      <copy todir="${target}/test-classes">
         <fileset dir="${basedir}/../../core/target/test-classes" includes="**/*"/>
      </copy>
      
      <!--Portlet test framework lib jar-->
      <jar jarfile="${test.temp.lib}/portal-portlet-test-framework-lib.jar">

         <!-- -->
         <fileset dir="${target}/classes" includes="org/gatein/pc/test/unit/**"/>

         <!--  JSR 168 TLD -->
         <zipfileset
            src="${dependency.portal-portlet-portlet.jar}"
            includes="META-INF/portlet.tld"
            fullpath="META-INF/portlet.tld"/>
         <zipfileset
            src="${dependency.portal-portlet-portlet.jar}"
            includes="META-INF/portlet_2_0.tld"
            fullpath="META-INF/portlet_2_0.tld"/>
      </jar>

      <package-tck-test test="portletinterface"/>
      <package-tck-test test="dispatcher"/>
      <package-tck-test test="portletrequests"/>
      <package-tck-test test="portletmode"/>
      <package-tck-test test="portletconfig"/>
      <package-tck-test test="portletresponses"/>
      <package-tck-test test="preferences"/>
      <package-tck-test test="portletsession"/>
      <package-tck-test test="portleturl"/>
      <package-tck-test test="windowstates"/>
      <package-tck-test test="portletcontext"/>
      <package-api-test test="portletconfig"/>
      <package-api-test test="portletmode"/>
      <package-api-test test="windowstate"/>
      <package-api-test test="portletsessionutil"/>
      <package-api-test test="portalcontext"/>
      <package-api-test test="portletcontext"/>
      <package-api-test test="portleturl"/>
      <package-api-test test="portletpreferences"/>
      <package-api-test test="portletsession"/>
      <package-api-test test="actionrequest"/>
      <package-api-test test="renderrequest"/>
      <package-api-test test="actionresponse"/>
      <package-api-test test="renderresponse"/>
      <package-ext-test test="nocache"/>
      <package-ext-test test="expiringcache"/>
      <package-ext-test test="neverexpiringcache"/>
      <package-ext-test test="preferences"/>
      <package-ext-test test="session"/>
      <package-ext-test test="portletresponses"/>
      <package-ext-test test="portletrequests"/>
      <package-ext-test test="portletmode"/>
      <package-ext-test test="portletconfig"/>
      <package-ext-test test="taglib"/>
      <package-jsr286-tck-test test="dispatcher"/>
      <package-jsr286-tck-test test="portletconfig"/>
      <package-jsr286-tck-test test="portletconfignonamespace"/>
      <package-jsr286-tck-test test="event"/>
      <package-jsr286-tck-test test="eventnonamespace"/>
      <package-jsr286-tck-test test="stateawareresponse"/>
      <package-jsr286-tck-test test="portletrequests"/>
      <package-jsr286-tck-test test="resourceserving"/>
      <package-jsr286-tck-test test="portleturl"/>
      <package-jsr286-tck-test test="portletfilter"/>
      <package-jsr286-tck-test test="taglib"/>
      <package-jsr286-tck-test test="userinformation"/>
      <package-jsr286-api-test test="event"/>
      <package-jsr286-api-test test="portleturl"/>
      <package-jsr286-ext-test test="portletrequests"/>
      <package-jsr286-ext-test test="portletfilter"/>
      <package-jsr286-ext-test test="portletresponses"/>
      <package-jsr286-ext-test test="dispatcher"/>
      <package-jsr286-ext-test test="portletcontext"/>
      <package-jsr286-ext-test test="portletinterface"/>
      <package-jsr286-ext-test test="event"/>
      <package-jsr286-ext-test test="eventsupport"/>
      <package-jsr286-ext-test test="portletmode"/>

      <!-- -->
      <jar jarfile="${test.temp.lib}/portlet-test-lib.jar">
         <fileset dir="${target}/test-classes"/>
         <fileset dir="${target}/classes"/>
      </jar>

      <copy todir="${test.temp.dir}/${test.server.name}-${test.server.version}/portlet-test-war">
         <fileset dir="${target}/test-classes/portlet-test-war"/>
      </copy>
      <copy todir="${test.temp.dir}/${test.server.name}-${test.server.version}/portlet-test-war/WEB-INF/lib" flatten="true">
         <fileset dir="${test.temp.lib}" includes="portlet-test-lib.jar"/>
         <path refid="${test.server.name}-${test.server.version}"/>
      </copy>
      <mkdir dir="${test.temp.lib}/${test.server.name}-${test.server.version}"/>
      <jar jarfile="${test.temp.lib}/${test.server.name}-${test.server.version}/portlet-test.war">
         <fileset dir="${test.temp.dir}/${test.server.name}-${test.server.version}/portlet-test-war"/>
      </jar>

      <!-- Strip cargo manager war filename-->
      <copy file="${dependency.cargo-manager.war}" tofile="${test.temp.lib}/manager.war"/>
      <!-- unjar the war -->
      <unzip src="${test.temp.lib}/manager.war" dest="${test.temp.lib}/manager"/>

   </target>

   <target name="__cargo.setup">
      <property name="cargo.log.dir" value="${target}/test/cargo"/>
      <mkdir dir="${cargo.log.dir}"/>
      <taskdef resource="cargo.tasks">
         <classpath>
            <pathelement path="${plugin_classpath}"/>
         </classpath>
      </taskdef>
   </target>

   <target name="test.container-servlet">
      <echo message="Starting ${test.server.name} ${test.server.version} with ${test.remote.server.name} to execute ${test.server.name} tests"/>
      <antcall target="cargo.start">
         <param name="cargo.wait" value="false"/>
      </antcall>
      <antcall target="__tests.remote">
         <param name="test.server.name" value="${test.remote.server.name}"/>
      </antcall>
      <antcall target="cargo.stop"/>
   </target>

   <target name="__tests.remote">

      <taskdef name="jboss-unit" classname="org.jboss.unit.tooling.ant.JBossUnitTask" classpath="${plugin_classpath}"/>

      <jboss-unit jpda="false" jpdaPort="9000" jpdaSuspend="true" failOnError="true">

         <tests config="${target}/test-classes/test/remote-jboss-unit.xml">
            <property name="archivePath" value="${test.temp.lib}"/>
            <property name="serverName" value="${test.server.name}"/>
         </tests>

         <reports>
            <xml toDir="${target}/tests/reports/xml/${test.server.name}"/>
            <html toDir="${target}/tests/reports/html/${test.server.name}"/>
         </reports>

         <classpath>
            <pathelement location="${target}/classes"/>
            <pathelement location="${test.temp.lib}"/>
            <pathelement location="${target}/classes/test"/>
            <pathelement location="${target}/test-classes/test"/>
            <pathelement path="${test_classpath}"/>
         </classpath>

      </jboss-unit>

   </target>

   <target name="package-tck-portal" depends="prepare_env">

      <property name="tck" value="${target}/tck"/>
      <property name="tck-server" value="${tck}/${test.server.name}-${test.server.version}"/>

      <mkdir dir="${tck}"/>
      <mkdir dir="${tck-server}"/>

      <jar jarfile="${target}/portlet-test-lib.jar">
         <fileset dir="${target}/classes" excludes="org/gatein/pc/portal/samples/**"/>
      </jar>

      <copy todir="${tck-server}/portlet-tck-war">
         <fileset dir="${target}/classes/portlet-tck-war"/>
      </copy>
      <copy todir="${tck-server}/portlet-tck-war">
         <fileset dir="${target}/classes/${test.server.name}-${test.server.version}/portlet-tck-war"/>
      </copy>

      <copy todir="${tck-server}/portlet-tck-war/WEB-INF/lib" flatten="true">
         <fileset dir="${target}" includes="portlet-test-lib.jar"/>
         <path refid="${test.server.name}-${test.server.version}"/>
      </copy>

      <mkdir dir="${tck-server}/tck-portal"/>

      <jar jarfile="${tck-server}/tck-portal/portlet-tck.war">
         <fileset dir="${tck-server}/portlet-tck-war"/>
      </jar>

      <copy todir="${tck-server}/tck-portal" flatten="true">
         <path refid="${test.server.name}-${test.server.version}-shared"/>
      </copy>

      <delete file="${target}/portlet-test-lib.jar"/>

   </target>

</project>
